# Logstash 파이프라인 설정 예시
# THINKFAST WAS 로그 처리 파이프라인

input {
  # 일반 로그 파일
  file {
    path => "/var/log/thinkfast/application.log"
    start_position => "beginning"
    codec => "json"
    sincedb_path => "/dev/null"
  }

  # 압축 파일 읽기 (한 줄이 하나의 JSON 로그)
  file {
    path => "/var/log/thinkfast/application.log.*.gz"
    start_position => "beginning"
    codec => "gzip_lines"
    sincedb_path => "/dev/null"
    tags => ["compressed"]
  }
}

filter {
  # 압축 파일에서 읽은 경우 JSON 파싱
  if "compressed" in [tags] {
    json {
      source => "message"
    }
  }

  # 일반 파일의 경우 이미 codec => "json"으로 파싱되므로 추가 파싱 불필요
  # 하지만 message 필드가 있는 경우를 대비한 파싱 (선택사항)
  if [message] =~ /^\{/ and "compressed" not in [tags] {
    json {
      source => "message"
      target => "parsed"
    }
  }

  # 타임스탬프 파싱
  date {
    match => [ "@timestamp", "ISO8601" ]
    target => "@timestamp"
  }

  # 로그 타입별 필드 정규화
  if [log_type] == "http_request" {
    mutate {
      rename => {
        "[http][method]" => "[http][method]"
        "[http][uri]" => "[http][uri]"
        "[http][status]" => "[http][status]"
        "[http][duration_ms]" => "[http][duration_ms]"
      }
    }
    
    # 느린 요청 태그 추가
    if [http][slow_request] == "true" {
      mutate {
        add_tag => [ "slow_request" ]
      }
    }
  }

  if [log_type] == "exception" {
    mutate {
      rename => {
        "[error][type]" => "[error][type]"
        "[error][message]" => "[error][message]"
        "[error][severity]" => "[error][severity]"
      }
    }
    
    # 심각한 에러 태그 추가
    if [error][severity] == "critical" {
      mutate {
        add_tag => [ "critical_error" ]
      }
    }
  }

  if [log_type] == "external_api" {
    mutate {
      rename => {
        "[external_api][system]" => "[external_api][system]"
        "[external_api][operation]" => "[external_api][operation]"
        "[external_api][duration_ms]" => "[external_api][duration_ms]"
        "[external_api][status]" => "[external_api][status]"
      }
    }
    
    # 실패한 외부 API 호출 태그 추가
    if [external_api][status] == "failure" {
      mutate {
        add_tag => [ "external_api_failure" ]
      }
    }
  }

  if [log_type] == "scheduler" {
    mutate {
      rename => {
        "[scheduler][job_name]" => "[scheduler][job_name]"
        "[scheduler][job_id]" => "[scheduler][job_id]"
        "[scheduler][execution_time_ms]" => "[scheduler][execution_time_ms]"
        "[scheduler][status]" => "[scheduler][status]"
      }
    }
    
    # 실패한 스케줄러 작업 태그 추가
    if [scheduler][status] == "failure" {
      mutate {
        add_tag => [ "scheduler_failure" ]
      }
    }
  }

  # GeoIP 처리 (클라이언트 IP)
  if [http][client_ip] {
    geoip {
      source => "[http][client_ip]"
      target => "[geoip]"
    }
  }

  # 사용자 에이전트 파싱
  if [http][user_agent] {
    useragent {
      source => "[http][user_agent]"
      target => "[user_agent]"
    }
  }
}

output {
  # Elasticsearch로 전송
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    user => "elastic"
    password => "test1234"  # ELASTIC_PASSWORD 값
    index => "thinkfast-logs-%{+yyyy.MM.dd}"
    # template_name => "thinkfast-logs"
    # template => "/etc/logstash/templates/thinkfast-logs-template.json"
    # template_overwrite => true
  }

  # 디버깅용 stdout (개발 환경에서만 사용)
  # stdout {
  #   codec => rubydebug
  # }
}

