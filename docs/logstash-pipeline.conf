# Logstash 파이프라인 설정 예시
# THINKFAST WAS 로그 처리 파이프라인

input {
  beats {
    port => 5044
  }
}

filter {
  # JSON 파싱 (이미 JSON 형식이므로)
  if [message] =~ /^\{/ {
    json {
      source => "message"
      target => "parsed"
    }
  }

  # 타임스탬프 파싱
  date {
    match => [ "@timestamp", "ISO8601" ]
    target => "@timestamp"
  }

  # 로그 타입별 필드 정규화
  if [log_type] == "http_request" {
    mutate {
      rename => {
        "[http][method]" => "[http][method]"
        "[http][uri]" => "[http][uri]"
        "[http][status]" => "[http][status]"
        "[http][duration_ms]" => "[http][duration_ms]"
      }
    }
    
    # 느린 요청 태그 추가
    if [http][slow_request] == "true" {
      mutate {
        add_tag => [ "slow_request" ]
      }
    }
  }

  if [log_type] == "exception" {
    mutate {
      rename => {
        "[error][type]" => "[error][type]"
        "[error][message]" => "[error][message]"
        "[error][severity]" => "[error][severity]"
      }
    }
    
    # 심각한 에러 태그 추가
    if [error][severity] == "critical" {
      mutate {
        add_tag => [ "critical_error" ]
      }
    }
  }

  if [log_type] == "external_api" {
    mutate {
      rename => {
        "[external_api][system]" => "[external_api][system]"
        "[external_api][operation]" => "[external_api][operation]"
        "[external_api][duration_ms]" => "[external_api][duration_ms]"
        "[external_api][status]" => "[external_api][status]"
      }
    }
    
    # 실패한 외부 API 호출 태그 추가
    if [external_api][status] == "failure" {
      mutate {
        add_tag => [ "external_api_failure" ]
      }
    }
  }

  if [log_type] == "scheduler" {
    mutate {
      rename => {
        "[scheduler][job_name]" => "[scheduler][job_name]"
        "[scheduler][job_id]" => "[scheduler][job_id]"
        "[scheduler][execution_time_ms]" => "[scheduler][execution_time_ms]"
        "[scheduler][status]" => "[scheduler][status]"
      }
    }
    
    # 실패한 스케줄러 작업 태그 추가
    if [scheduler][status] == "failure" {
      mutate {
        add_tag => [ "scheduler_failure" ]
      }
    }
  }

  # GeoIP 처리 (클라이언트 IP)
  if [http][client_ip] {
    geoip {
      source => "[http][client_ip]"
      target => "[geoip]"
    }
  }

  # 사용자 에이전트 파싱
  if [http][user_agent] {
    useragent {
      source => "[http][user_agent]"
      target => "[user_agent]"
    }
  }
}

output {
  # Elasticsearch로 전송
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "thinkfast-logs-%{+yyyy.MM.dd}"
    template_name => "thinkfast-logs"
    template => "/etc/logstash/templates/thinkfast-logs-template.json"
    template_overwrite => true
  }

  # 디버깅용 stdout (개발 환경에서만 사용)
  # stdout {
  #   codec => rubydebug
  # }
}

